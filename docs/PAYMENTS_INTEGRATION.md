# üí≥ Payments API - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–æ–∑–¥–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ÆKassa, Stripe –∏–ª–∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏.

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `payments`

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö –≤ —Å–∏—Å—Ç–µ–º–µ.

**–ü–æ–ª—è:**
- `id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–ª–∞—Ç–µ–∂–∞
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `booking_id` - ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –æ–ø–ª–∞—Ç—ã –±–∞–Ω—å/–º–∞—Å—Ç–µ—Ä–æ–≤)
- `event_registration_id` - ID —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–¥–ª—è –æ–ø–ª–∞—Ç—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π)
- `amount` - –°—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö/—Ü–µ–Ω—Ç–∞—Ö
- `currency` - –í–∞–ª—é—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RUB)
- `status` - –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞:
  - `pending` - –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
  - `processing` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
  - `succeeded` - —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω
  - `canceled` - –æ—Ç–º–µ–Ω–µ–Ω
  - `refunded` - –≤–æ–∑–≤—Ä–∞—â–µ–Ω
- `payment_method` - –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (card, sbp, yandex_money –∏ —Ç.–¥.)
- `provider` - –ü–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä:
  - `yookassa` - –ÆKassa (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –†–§)
  - `stripe` - Stripe (–¥–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
  - `manual` - —Ä—É—á–Ω–æ–π –ø–ª–∞—Ç–µ–∂ (–Ω–∞–ª–∏—á–Ω—ã–µ, –ø–µ—Ä–µ–≤–æ–¥)
- `provider_payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `provider_response` - –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (JSON)
- `paid_at` - –î–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- `refunded_at` - –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
- `refund_reason` - –ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
- `created_at` - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` - –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**Constraint:**
- –ü–ª–∞—Ç–µ–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –ª–∏–±–æ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é, –ª–∏–±–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–Ω–µ –∫ –æ–±–æ–∏–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

---

### –¢–∞–±–ª–∏—Ü–∞ `payment_webhooks`

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö webhook'–æ–≤ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∞—É–¥–∏—Ç–∞.

**–ü–æ–ª—è:**
- `id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID webhook
- `provider` - –ü—Ä–æ–≤–∞–π–¥–µ—Ä (yookassa, stripe)
- `event_type` - –¢–∏–ø —Å–æ–±—ã—Ç–∏—è (payment.succeeded, payment.canceled –∏ —Ç.–¥.)
- `payload` - –ü–æ–ª–Ω—ã–π payload –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (JSON)
- `payment_id` - –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω)
- `processed` - –û–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ webhook
- `processed_at` - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `error_message` - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
- `created_at` - –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook

---

## üîå –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ:
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ webhooks
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –°–≤—è–∑–∏ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhooks –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 1. Backend —Ñ—É–Ω–∫—Ü–∏—è `/backend/payments/`
```python
# –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
# POST /create - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
# GET /?payment_id={id} - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
# POST /webhook - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhooks
# POST /refund - –≤–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞
```

#### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º (–ÆKassa)
```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: yookassa
# –°–µ–∫—Ä–µ—Ç—ã: YOOKASSA_SHOP_ID, YOOKASSA_SECRET_KEY
# API: https://yookassa.ru/developers/api
```

#### 3. Workflow –æ–ø–ª–∞—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (status='pending')
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ (status='pending')
3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
4. Webhook –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
5. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ status='confirmed'

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
```javascript
const createPayment = async (bookingId, amount) => {
  const token = localStorage.getItem('access_token');
  
  const response = await fetch('https://functions.poehali.dev/[PAYMENTS_FUNCTION_ID]/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      booking_id: bookingId,
      amount: amount,
      currency: 'RUB',
      return_url: 'https://yourdomain.com/payment/success'
    })
  });
  
  const data = await response.json();
  // data.confirmation_url - —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
  window.location.href = data.confirmation_url;
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
```javascript
const checkPayment = async (paymentId) => {
  const token = localStorage.getItem('access_token');
  const params = new URLSearchParams({ payment_id: paymentId });
  
  const response = await fetch(`https://functions.poehali.dev/[PAYMENTS_FUNCTION_ID]/?${params}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  return response.json();
};
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

### –î–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ —Ä—ã–Ω–∫–∞ (–ÆKassa):
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://yookassa.ru/
2. –ü–æ–ª—É—á–∏—Ç—å `shopId` –∏ `secretKey`
3. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã —á–µ—Ä–µ–∑ `put_secret`:
   - `YOOKASSA_SHOP_ID`
   - `YOOKASSA_SECRET_KEY`
4. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `/backend/payments/` —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π `yookassa`
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

### –î–ª—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (Stripe):
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://stripe.com/
2. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á–∏ (publishable –∏ secret)
3. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã:
   - `STRIPE_PUBLISHABLE_KEY`
   - `STRIPE_SECRET_KEY`
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `stripe` –≤ Python

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Payments API –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–≤—Ä–∞—Ç—ã –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü
- –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
- –ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏

---

**–°—Ç–∞—Ç—É—Å:** üü¢ –ë–∞–∑–∞ –≥–æ—Ç–æ–≤–∞, –æ–∂–∏–¥–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ API

–ö–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤ –≤–Ω–µ–¥—Ä—è—Ç—å –ø–ª–∞—Ç–µ–∂–∏ - —Å–∫–∞–∂–∏, –∏ —è —Å–æ–∑–¥–∞–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Payments API —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ÆKassa –∏–ª–∏ Stripe!
